# VR3D é¡¹ç›®æ¶æ„ä¸å®ç°è¯¦è§£

## ğŸ“ æ•´ä½“æ¶æ„

```
Vue App (main.ts â†’ App.vue)
    â†“
ThreeScene.vue (ä¸»åœºæ™¯ç»„ä»¶)
    â”œâ”€â”€ useThree (Three.js æ ¸å¿ƒåˆå§‹åŒ–)
    â”œâ”€â”€ useInputController (ç»Ÿä¸€è¾“å…¥æŠ½è±¡å±‚)
    â”œâ”€â”€ useVRControllers (VR æ‰‹æŸ„ç®¡ç†)
    â”œâ”€â”€ BasicScene (åœºæ™¯å¯¹è±¡ç®¡ç†)
    â””â”€â”€ è°ƒè¯•å·¥å…· (VRDebugPanel, DebugGUI, VRDebugGUI)
```

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**è·¨å¹³å° VR/æ¡Œé¢ 3D åº”ç”¨**ï¼ŒåŸºäº **Vue 3 + Three.js + WebXR** å®ç°ã€‚

**æŠ€æœ¯æ ˆï¼š**
- Vue 3 + TypeScript
- Three.js (3D æ¸²æŸ“å¼•æ“)
- WebXR (VR è®¾å¤‡æ”¯æŒ)
- lil-gui (æ¡Œé¢è°ƒè¯• GUI)
- Vite (æ„å»ºå·¥å…·)

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- åŒæ—¶æ”¯æŒæ¡Œé¢å’Œ VR æ¨¡å¼
- ç»Ÿä¸€çš„è¾“å…¥æŠ½è±¡å±‚
- VR Player Rig ç³»ç»Ÿ
- å®Œæ•´çš„è°ƒè¯•å·¥å…·é“¾

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. useThree.ts - Three.js åŸºç¡€è®¾æ–½

**èŒè´£ï¼š**
- åˆ›å»º Sceneã€Cameraã€Renderer
- å¯ç”¨ WebXR (`renderer.xr.enabled = true`)
- VR Player Rig ç³»ç»Ÿï¼ˆå…³é”®åˆ›æ–°ç‚¹ï¼‰
- æ¡Œé¢æ¨¡å¼ä½¿ç”¨ OrbitControls

#### VR Player Rig æœºåˆ¶

```typescript
// åˆ›å»º VR ç©å®¶å®¹å™¨ï¼ˆç”¨äºä¼ é€ç§»åŠ¨ï¼‰
const vrPlayerRig = new THREE.Group()
vrPlayerRig.name = 'VRPlayerRig'
scene.add(vrPlayerRig)
```

**å·¥ä½œåŸç†ï¼š**

**æ¡Œé¢æ¨¡å¼ï¼š**
- ç›¸æœºç›´æ¥æ·»åŠ åˆ° scene
- OrbitControls æ§åˆ¶ç›¸æœºä½ç½®å’Œæ—‹è½¬

**VR æ¨¡å¼åˆ‡æ¢ï¼š**

è¿›å…¥ VR (`sessionstart`):
```typescript
scene.remove(camera)          // ä»åœºæ™¯ç§»é™¤ç›¸æœº
vrPlayerRig.add(camera)       // æ·»åŠ åˆ° rig
camera.position.set(0, 0, 0)  // å±€éƒ¨ä½ç½®å½’é›¶ï¼ˆå¤´æ˜¾æ§åˆ¶ç›¸å¯¹ä½ç½®ï¼‰
controls.enabled = false       // ç¦ç”¨ OrbitControls
```

é€€å‡º VR (`sessionend`):
```typescript
vrPlayerRig.remove(camera)    // ä» rig ç§»é™¤
scene.add(camera)             // æ·»åŠ å›åœºæ™¯
camera.position.copy(worldPos) // æ¢å¤ä¸–ç•Œä½ç½®
controls.enabled = true        // æ¢å¤ OrbitControls
```

**è®¾è®¡åŸå› ï¼š**
- VR ä¸­å¤´æ˜¾è‡ªåŠ¨æ§åˆ¶ç›¸æœºçš„å±€éƒ¨ä½ç½®/æ—‹è½¬
- ç§»åŠ¨ç©å®¶æ—¶åªéœ€ç§»åŠ¨ rigï¼Œä¸å¹²æ‰°å¤´æ˜¾è¿½è¸ª
- æ¡Œé¢æ¨¡å¼ä¿æŒä¼ ç»Ÿç›¸æœºæ§åˆ¶æ–¹å¼

#### æ¸²æŸ“å¾ªç¯

```typescript
// VR æ¨¡å¼ä½¿ç”¨ setAnimationLoopï¼ˆä¸ WebXR åŒæ­¥ï¼‰
renderer.setAnimationLoop(() => {
  if (updateFn) updateFn()
  renderer.render(scene, camera)
})

// é VR æ¨¡å¼ä½¿ç”¨ requestAnimationFrame
const loop = () => {
  animationId = requestAnimationFrame(loop)
  if (updateFn) updateFn()
  renderer.render(scene, camera)
}
```

---

### 2. useInputController.ts - ç»Ÿä¸€è¾“å…¥æŠ½è±¡å±‚

**æ ¸å¿ƒæ€æƒ³ï¼š** å°†æ¡Œé¢å’Œ VR çš„ä¸åŒè¾“å…¥æ–¹å¼ç»Ÿä¸€åˆ°ç›¸åŒçš„äº‹ä»¶æ¥å£ã€‚

#### è¾“å…¥äº‹ä»¶æ¥å£

```typescript
interface InputEvents {
  onSelectStart?: (position, direction, hand) => void
  onSelectEnd?: (position, direction, hand) => void
  onGrabStart?: (position, direction, hand) => void
  onGrabEnd?: (position, direction, hand) => void
  onMove?: (delta: Vector2) => void
  onJump?: () => void
}
```

#### æ¡Œé¢æ¨¡å¼è¾“å…¥æ˜ å°„

| è¾“å…¥ | äº‹ä»¶ | è¯´æ˜ |
|------|------|------|
| å·¦é”®ç‚¹å‡» | `onSelectStart` | é€‰æ‹©ç‰©ä½“ |
| å³é”®ç‚¹å‡» | `onGrabStart` | æŠ“å–ç‰©ä½“ |
| WASD | `onMove` | ç§»åŠ¨ |
| ç©ºæ ¼ | `onJump` | è·³è·ƒ |
| é¼ æ ‡ç§»åŠ¨ | æ›´æ–° raycaster | å°„çº¿æ–¹å‘ |

**å®ç°ç»†èŠ‚ï¼š**
```typescript
function onMouseDown(event: MouseEvent) {
  if (event.button === 0) { // å·¦é”®
    events.onSelectStart?.(cursorPosition, cursorDirection, 'right')
  } else if (event.button === 2) { // å³é”®
    events.onGrabStart?.(cursorPosition, cursorDirection, 'right')
  }
}

function updateDesktopInput() {
  const moveX = (keysPressed.has('d') ? 1 : 0) + (keysPressed.has('a') ? -1 : 0)
  const moveY = (keysPressed.has('w') ? 1 : 0) + (keysPressed.has('s') ? -1 : 0)
  if (moveX !== 0 || moveY !== 0) {
    events.onMove?.(new Vector2(moveX, moveY))
  }
}
```

#### VR æ¨¡å¼è¾“å…¥

VR æ¨¡å¼é€šè¿‡å¤–éƒ¨è°ƒç”¨ä»¥ä¸‹æ–¹æ³•è§¦å‘äº‹ä»¶ï¼š
```typescript
triggerVRSelect(position, direction, hand)
triggerVRGrab(position, direction, hand)
triggerVRMove(delta)
```

#### æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢

```typescript
renderer.xr.addEventListener('sessionstart', () => {
  isVRMode.value = true
})
renderer.xr.addEventListener('sessionend', () => {
  isVRMode.value = false
})
```

---

### 3. useVRControllers.ts - VR æ‰‹æŸ„ç®¡ç†

**èŒè´£ï¼š**
- åˆ›å»ºå’Œç®¡ç†å·¦å³æ‰‹æ§åˆ¶å™¨
- ç›‘å¬ WebXR æ§åˆ¶å™¨äº‹ä»¶
- æä¾›æ‰‹æŸ„çŠ¶æ€æŸ¥è¯¢æ¥å£

#### æ§åˆ¶å™¨åˆ›å»º

```typescript
function createController(index: number) {
  // äº¤äº’æ§åˆ¶å™¨ï¼ˆç”¨äºå°„çº¿æ£€æµ‹ï¼‰
  const controller = renderer.xr.getController(index)
  
  // æ·»åŠ å°„çº¿å¯è§†åŒ–
  const line = new THREE.Line(geometry, material)
  line.scale.z = 5
  controller.add(line)
  
  // æ‰‹æŸ„æ¨¡å‹ï¼ˆæ˜¾ç¤ºæ‰‹æŸ„å¤–è§‚ï¼‰
  const controllerGrip = renderer.xr.getControllerGrip(index)
  const model = controllerModelFactory.createControllerModel(controllerGrip)
  controllerGrip.add(model)
  
  return { controller, controllerGrip, line }
}

controllers.push(createController(0)) // å·¦æ‰‹
controllers.push(createController(1)) // å³æ‰‹
```

#### WebXR äº‹ä»¶ç›‘å¬

```typescript
// æ‰³æœºé”®ï¼ˆé€‰æ‹©ï¼‰
controller.addEventListener('selectstart', () => {
  onSelectStart?.(controller, index)
})

// ä¾§é”®ï¼ˆæŠ“å–ï¼‰
controller.addEventListener('squeezestart', () => {
  onSqueezeStart?.(controller, index)
})
```

#### æ‰‹æŸ„çŠ¶æ€æŸ¥è¯¢

**Quest æ§åˆ¶å™¨æŒ‰é’®å¸ƒå±€ï¼š**

| ç´¢å¼• | æŒ‰é’® | åç§° |
|------|------|------|
| 0 | Trigger | æ‰³æœº |
| 1 | Squeeze | ä¾§é”® |
| 3 | Thumbstick | æ‘‡æ†æŒ‰ä¸‹ |
| 4 | X/A | Xé”®(å·¦) / Aé”®(å³) |
| 5 | Y/B | Yé”®(å·¦) / Bé”®(å³) |
| 12 | Menu | èœå•é”® |

```typescript
function getGamepadState(index: number) {
  const gamepad = session.inputSources[index]?.gamepad
  return {
    buttons: gamepad.buttons.map(b => ({
      pressed: b.pressed,
      touched: b.touched,
      value: b.value
    })),
    // å¿«æ·æ–¹å¼
    trigger: gamepad.buttons[0]?.value || 0,
    squeeze: gamepad.buttons[1]?.value || 0,
    thumbstickX: gamepad.axes[2] || 0,  // æ‘‡æ† X
    thumbstickY: gamepad.axes[3] || 0,  // æ‘‡æ† Y
  }
}
```

#### æ§åˆ¶å™¨çˆ¶å¯¹è±¡ç®¡ç†

```typescript
function moveControllersToParent(parent: THREE.Object3D) {
  controllers.forEach(({ controller, controllerGrip }) => {
    controller.parent?.remove(controller)
    controllerGrip.parent?.remove(controllerGrip)
    parent.add(controller)
    parent.add(controllerGrip)
  })
}
```

**ç”¨é€”ï¼š** VR ä¼šè¯å¼€å§‹æ—¶ï¼Œå°†æ§åˆ¶å™¨ä» scene ç§»åˆ° VRPlayerRigï¼Œç¡®ä¿æ§åˆ¶å™¨è·Ÿéšç©å®¶ç§»åŠ¨ã€‚

---

### 4. ThreeScene.vue - ä¸»é€»è¾‘ç¼–æ’

è¿™æ˜¯æ•´ä¸ªåº”ç”¨çš„**æŒ‡æŒ¥ä¸­å¿ƒ**ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰æ¨¡å—ã€‚

#### åˆå§‹åŒ–æµç¨‹

```typescript
onMounted(() => {
  // 1. è·å– Three.js ä¸Šä¸‹æ–‡
  const { scene, renderer, camera } = getContext()
  
  // 2. åˆ›å»ºåœºæ™¯å†…å®¹
  const basicScene = new BasicScene(scene)
  
  // 3. åˆ›å»ºè°ƒè¯•å·¥å…·
  const debugPanel = new VRDebugPanel(scene)
  const debugGUI = new DebugGUI(debugPanel, camera)
  const vrDebugGUI = new VRDebugGUI(scene, debugPanel, camera)
  
  // 4. å®šä¹‰æ¸¸æˆé€»è¾‘
  const gameLogic = { ... }
  
  // 5. è®¾ç½®è¾“å…¥æ§åˆ¶å™¨
  const inputController = useInputController(camera, renderer, canvas, {
    onSelectStart: gameLogic.handleSelectStart,
    onMove: gameLogic.handleMove,
    ...
  })
  
  // 6. è®¾ç½® VR æ§åˆ¶å™¨
  const { controllers } = useVRControllers(renderer, scene, {
    onSelectStart: (controller, index) => {
      // æ¡¥æ¥åˆ°ç»Ÿä¸€è¾“å…¥
      gameLogic.handleSelectStart(pos, dir, hand)
    },
    ...
  })
  
  // 7. å¯åŠ¨æ¸²æŸ“å¾ªç¯
  animate(() => { ... })
})
```

#### æ¸¸æˆé€»è¾‘å¯¹è±¡

```typescript
const gameLogic = {
  // é€‰æ‹©å¼€å§‹ï¼šå°„çº¿æ£€æµ‹ â†’ é«˜äº®ç‰©ä½“
  handleSelectStart: (position, direction, hand) => {
    const raycaster = new Raycaster(position, direction)
    const intersections = raycaster.intersectObjects(
      basicScene.getInteractables()
    )
    if (intersections[0]?.object) {
      basicScene.highlightObject(intersections[0].object)
    }
  },
  
  // æŠ“å–å¼€å§‹ï¼šæ£€æµ‹ â†’ é™„åŠ åˆ°æ§åˆ¶å™¨
  handleGrabStart: (position, direction, hand, controller?) => {
    const intersections = raycaster.intersectObjects(...)
    if (intersections[0]?.object) {
      grabbedObject = intersections[0].object
      
      // VR æ¨¡å¼ï¼šç‰©ä½“æˆä¸ºæ§åˆ¶å™¨å­å¯¹è±¡
      if (controller) {
        controller.attach(grabbedObject)
      }
    }
  },
  
  // æŠ“å–ç»“æŸï¼šåˆ†ç¦»å›åœºæ™¯
  handleGrabEnd: (hand, controller?) => {
    if (grabbedObject && controller) {
      scene.attach(grabbedObject)  // ä¸–ç•Œåæ ‡è½¬æ¢
    }
    grabbedObject = null
  },
  
  // ç§»åŠ¨ï¼šåŸºäºç›¸æœºæœå‘è®¡ç®—æ–¹å‘
  handleMove: (delta: Vector2) => {
    const direction = new Vector3(0, 0, -1)
    direction.applyQuaternion(camera.quaternion)
    direction.y = 0  // å¿½ç•¥ Y è½´
    direction.normalize()
    
    const strafe = new Vector3(-direction.z, 0, direction.x)
    
    // ç§»åŠ¨ç›®æ ‡ï¼šVR æ¨¡å¼ç§»åŠ¨ rigï¼Œæ¡Œé¢æ¨¡å¼ç§»åŠ¨ç›¸æœº
    const target = camera.parent || camera
    target.position.addScaledVector(direction, -delta.y * speed)
    target.position.addScaledVector(strafe, delta.x * speed)
  },
  
  // è·³è·ƒï¼šæ–½åŠ å‘ä¸Šé€Ÿåº¦
  handleJump: () => {
    const target = camera.parent || camera
    if (target.position.y <= groundLevel) {
      verticalVelocity = jumpStrength
    }
  }
}
```

#### æ¸²æŸ“å¾ªç¯

```typescript
animate(() => {
  // 1. åœºæ™¯æ›´æ–°
  basicScene.update()  // æ—‹è½¬æ–¹å—
  
  // 2. ç‰©ç†æ¨¡æ‹Ÿ
  verticalVelocity += gravity
  const target = camera.parent || camera
  target.position.y += verticalVelocity
  
  // åœ°é¢ç¢°æ’
  if (target.position.y < groundLevel) {
    target.position.y = groundLevel
    verticalVelocity = 0
  }
  
  // 3. æ¡Œé¢æ¨¡å¼
  if (!inputController.isVRMode.value) {
    inputController.updateDesktopInput()  // å¤„ç† WASD
    
    // æ‹–æ‹½ç‰©ä½“è·Ÿéšé¼ æ ‡
    if (grabbedObject && grabHand === 'desktop') {
      grabbedObject.position.copy(pos).add(dir.multiplyScalar(2))
    }
  }
  
  // 4. VR æ¨¡å¼
  else {
    // è¯»å–æ‰‹æŸ„çŠ¶æ€
    [0, 1].forEach(index => {
      const gamepad = getGamepadState(index)
      
      // æ£€æµ‹æŒ‰é’®å˜åŒ–
      gamepad.buttons.forEach((button, btnIndex) => {
        if (isPressed && !wasPressed) {
          // Aé”®è·³è·ƒ
          if (hand === 'Right' && btnIndex === 4) {
            gameLogic.handleJump()
          }
        }
      })
      
      // æ‘‡æ†ç§»åŠ¨ï¼ˆå³æ‰‹ï¼‰
      if (index === 1) {
        if (Math.abs(gamepad.thumbstickX) > deadzone) {
          inputController.triggerVRMove(
            new Vector2(gamepad.thumbstickX, gamepad.thumbstickY)
          )
        }
      }
    })
    
    // VR GUI äº¤äº’
    controllers.forEach(({ controller }) => {
      vrDebugGUI.handleControllerHover(controller)
      vrDebugGUI.handleControllerMove(controller)
    })
  }
})
```

#### VR ä¼šè¯ç›‘å¬

```typescript
renderer.xr.addEventListener('sessionstart', () => {
  // å°†æ§åˆ¶å™¨ç§»åˆ° VRPlayerRig
  const rig = scene.getObjectByName('VRPlayerRig')
  if (rig) {
    moveControllersToParent(rig)
  }
})

renderer.xr.addEventListener('sessionend', () => {
  // æ§åˆ¶å™¨ç§»å›åœºæ™¯
  moveControllersToParent(scene)
})
```

---

### 5. BasicScene.ts - åœºæ™¯å†…å®¹ç®¡ç†

ç®€å•çš„åœºæ™¯ç®¡ç†ç±»ï¼Œè´Ÿè´£åˆ›å»ºå’Œç®¡ç†åœºæ™¯ä¸­çš„ 3D å¯¹è±¡ã€‚

```typescript
export class BasicScene {
  private cube: THREE.Mesh
  private floor: THREE.Mesh
  private lights: THREE.Light[]
  private interactables: THREE.Object3D[] = []
  
  constructor(scene: THREE.Scene) {
    this.cube = this.createCube()
    this.floor = this.createFloor()
    this.setupLights()
    
    // æ·»åŠ åˆ°åœºæ™¯
    scene.add(this.cube, this.floor, ...this.lights)
    
    // æ ‡è®°å¯äº¤äº’å¯¹è±¡
    this.interactables.push(this.cube)
  }
  
  update() {
    // æ—‹è½¬åŠ¨ç”»
    this.cube.rotation.x += 0.01
    this.cube.rotation.y += 0.01
  }
  
  highlightObject(object: THREE.Object3D | null) {
    // é‡ç½®æ‰€æœ‰å¯¹è±¡
    this.cube.material.emissive.setHex(0x000000)
    
    // é«˜äº®é€‰ä¸­çš„å¯¹è±¡
    if (object?.material) {
      object.material.emissive.setHex(0x555555)
    }
  }
  
  getInteractables() {
    return this.interactables
  }
}
```

---

### 6. è°ƒè¯•ç³»ç»Ÿ

#### VRDebugPanel - 3D ç©ºé—´æ—¥å¿—é¢æ¿

åœ¨ VR ç©ºé—´ä¸­æ˜¾ç¤ºæ—¥å¿—ä¿¡æ¯ã€‚

**å®ç°åŸç†ï¼š**
```typescript
// 1. åˆ›å»º Canvas ç»˜åˆ¶æ–‡å­—
this.canvas = document.createElement('canvas')
this.context = canvas.getContext('2d')

// 2. è½¬æ¢ä¸ºçº¹ç†
this.texture = new CanvasTexture(canvas)

// 3. è´´åˆ°å¹³é¢å‡ ä½•ä½“
const material = new MeshBasicMaterial({ map: texture })
this.panel = new Mesh(new PlaneGeometry(0.5, 0.5), material)
scene.add(panel)

// 4. æ›´æ–°æ—¥å¿—
updateCanvas() {
  ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'
  ctx.fillRect(0, 0, width, height)
  
  ctx.fillStyle = '#ffffff'
  ctx.font = '16px monospace'
  logs.forEach((log, i) => {
    ctx.fillText(log, 10, startY + i * lineHeight)
  })
  
  texture.needsUpdate = true
}
```

**æ‹¦æˆª console è¾“å‡ºï¼š**
```typescript
console.log = (...args) => {
  originalLog.apply(console, args)
  this.addLog('LOG: ' + args.join(' '))
}
```

#### DebugGUI - æ¡Œé¢ 2D GUI

åŸºäº `lil-gui` åº“ï¼Œæä¾›ç²¾ç»†çš„å‚æ•°è°ƒæ•´ã€‚

```typescript
export class DebugGUI {
  private gui: GUI
  
  constructor(debugPanel, camera) {
    this.gui = new GUI({ title: 'è°ƒè¯•é¢æ¿' })
    
    // è°ƒè¯•é¢æ¿ä½ç½®æ§åˆ¶
    const panelFolder = gui.addFolder('è°ƒè¯•é¢æ¿ä½ç½®')
    panelFolder.add(panel.position, 'x', -5, 5, 0.1)
    panelFolder.add(panel.position, 'y', 0, 3, 0.1)
    panelFolder.add(panel.position, 'z', -5, 5, 0.1)
    
    // é¢„è®¾ä½ç½®
    panelFolder.add({
      å‰æ–¹: () => panel.position.set(0, 1.6, -2)
    }, 'å‰æ–¹')
    
    // ç›¸æœºæ§åˆ¶
    const cameraFolder = gui.addFolder('æ‘„åƒå¤´ä½ç½®')
    cameraFolder.add(camera.position, 'x', -10, 10)
    cameraFolder.add(camera, 'fov', 30, 120).onChange(() => {
      camera.updateProjectionMatrix()
    })
  }
  
  toggle() {
    this.gui._hidden ? this.gui.show() : this.gui.hide()
  }
}
```

**å¿«æ·é”®ï¼š** æŒ‰ H é”®åˆ‡æ¢æ˜¾ç¤º

#### VRDebugGUI - VR 3D äº¤äº’å¼ GUI

å®Œå…¨ç”¨ Three.js å‡ ä½•ä½“æ„å»ºçš„ 3D UIï¼Œæ”¯æŒ VR æ§åˆ¶å™¨äº¤äº’ã€‚

**ç»„ä»¶ç±»å‹ï¼š**

1. **æŒ‰é’® (Button3D)**
```typescript
createButton(label, x, y, action) {
  // æŒ‰é’®èƒŒæ™¯
  const mesh = new Mesh(
    new PlaneGeometry(width, height),
    new MeshBasicMaterial({ color: 0x3366cc })
  )
  
  // æ–‡å­—ï¼ˆCanvas çº¹ç†ï¼‰
  const text = this.createText(label)
  
  return { mesh, action, hoverColor, normalColor }
}
```

2. **æ»‘å— (Slider3D)**
```typescript
createSlider(label, value, min, max, onChange) {
  const group = new Group()
  
  // è½¨é“
  const track = new Mesh(
    new PlaneGeometry(0.4, 0.02),
    new MeshBasicMaterial({ color: 0x444444 })
  )
  
  // æ‰‹æŸ„
  const handle = new Mesh(
    new PlaneGeometry(0.03, 0.06),
    new MeshBasicMaterial({ color: 0x00ff88 })
  )
  
  // è®¡ç®—æ‰‹æŸ„ä½ç½®
  const normalized = (value - min) / (max - min)
  handle.position.x = -0.1 + normalized * 0.4
  
  return { group, handle, value, min, max, onChange }
}
```

**VR æ§åˆ¶å™¨äº¤äº’ï¼š**

```typescript
// é€‰æ‹©ï¼ˆç‚¹å‡»æŒ‰é’®/å¼€å§‹æ‹–æ‹½æ»‘å—ï¼‰
handleControllerSelect(controller) {
  const raycaster = new Raycaster()
  raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld)
  raycaster.ray.direction.set(0, 0, -1).applyQuaternion(controller.quaternion)
  
  // æ£€æŸ¥æŒ‰é’®
  for (const button of this.buttons) {
    if (raycaster.intersectObject(button.mesh).length > 0) {
      button.action()  // æ‰§è¡Œå›è°ƒ
      return
    }
  }
  
  // æ£€æŸ¥æ»‘å—
  for (const slider of this.sliders) {
    if (raycaster.intersectObject(slider.handle).length > 0) {
      slider.isDragging = true
      this.draggedSlider = slider
      return
    }
  }
}

// æ‹–æ‹½æ»‘å—
handleControllerMove(controller) {
  if (!this.draggedSlider) return
  
  // è®¡ç®—å°„çº¿ä¸æ»‘å—å¹³é¢çš„äº¤ç‚¹
  const plane = new Plane(new Vector3(0, 0, 1), 0)
  plane.applyMatrix4(this.draggedSlider.group.matrixWorld)
  
  const intersection = raycaster.ray.intersectPlane(plane)
  
  // è½¬æ¢åˆ°å±€éƒ¨åæ ‡å¹¶é™åˆ¶èŒƒå›´
  this.draggedSlider.group.worldToLocal(intersection)
  const x = clamp(intersection.x, -0.1, 0.3)
  
  // æ›´æ–°å€¼
  const normalized = (x + 0.1) / 0.4
  const value = min + normalized * (max - min)
  this.draggedSlider.onChange(value)
}

// æ‚¬åœé«˜äº®
handleControllerHover(controller) {
  // é‡ç½®æ‰€æœ‰æŒ‰é’®é¢œè‰²
  buttons.forEach(btn => btn.material.color.setHex(btn.normalColor))
  
  // é«˜äº®æ‚¬åœçš„æŒ‰é’®
  for (const button of this.buttons) {
    if (raycaster.intersectObject(button.mesh).length > 0) {
      button.material.color.setHex(button.hoverColor)
    }
  }
}
```

**å¿«æ·é”®ï¼š** æŒ‰ G é”®åˆ‡æ¢æ˜¾ç¤º

---

## ğŸ® äº¤äº’æµç¨‹ç¤ºä¾‹

### æ¡Œé¢æ¨¡å¼ - æŠ“å–ç‰©ä½“

1. ç”¨æˆ·æŒ‰ä¸‹**å³é”®**
2. `onMouseDown` è§¦å‘ â†’ `events.onGrabStart` å›è°ƒ
3. `gameLogic.handleGrabStart` æ‰§è¡Œï¼š
   ```typescript
   const raycaster = new Raycaster(position, direction)
   const intersections = raycaster.intersectObjects(interactables)
   grabbedObject = intersections[0].object
   ```
4. æ¯å¸§æ¸²æŸ“æ—¶ï¼š
   ```typescript
   grabbedObject.position.copy(pos).add(dir.multiplyScalar(2))
   ```
5. ç”¨æˆ·æ¾å¼€å³é”® â†’ `onGrabEnd` â†’ `grabbedObject = null`

### VR æ¨¡å¼ - æŠ“å–ç‰©ä½“

1. ç”¨æˆ·æŒ‰ä¸‹**ä¾§é”®** (Squeeze)
2. `squeezestart` äº‹ä»¶ â†’ `onSqueezeStart` å›è°ƒ
3. `gameLogic.handleGrabStart` æ‰§è¡Œï¼š
   ```typescript
   grabbedObject = intersections[0].object
   controller.attach(grabbedObject)  // ç‰©ä½“æˆä¸ºæ§åˆ¶å™¨å­å¯¹è±¡
   ```
4. æ‰‹æŸ„ç§»åŠ¨ â†’ ç‰©ä½“**è‡ªåŠ¨è·Ÿéš**ï¼ˆThree.js çˆ¶å­å…³ç³»ï¼‰
5. ç”¨æˆ·æ¾å¼€ä¾§é”® â†’ `squeezeend` â†’ `scene.attach(grabbedObject)` åˆ†ç¦»å›åœºæ™¯

### VR æ¨¡å¼ - æ‘‡æ†ç§»åŠ¨

1. ä¸»å¾ªç¯è¯»å–æ‰‹æŸ„çŠ¶æ€ï¼š
   ```typescript
   const gamepad = getGamepadState(1)  // å³æ‰‹
   const x = gamepad.thumbstickX
   const y = gamepad.thumbstickY
   ```
2. è¶…è¿‡æ­»åŒºé˜ˆå€¼ â†’ `triggerVRMove(new Vector2(x, y))`
3. `gameLogic.handleMove` è®¡ç®—ç§»åŠ¨ï¼š
   ```typescript
   const direction = new Vector3(0, 0, -1)
   direction.applyQuaternion(camera.quaternion)
   direction.y = 0  // æ°´å¹³ç§»åŠ¨
   
   const strafe = new Vector3(-direction.z, 0, direction.x)
   
   // ç§»åŠ¨ VRPlayerRig
   const rig = camera.parent
   rig.position.addScaledVector(direction, -delta.y * speed)
   rig.position.addScaledVector(strafe, delta.x * speed)
   ```

### VR GUI - æ‹–æ‹½æ»‘å—

1. ç”¨æˆ·æ‰³æœºå¯¹å‡†æ»‘å—æ‰‹æŸ„ â†’ `handleControllerSelect`
2. å°„çº¿æ£€æµ‹åˆ°æ‰‹æŸ„ â†’ `slider.isDragging = true`
3. æ¯å¸§è°ƒç”¨ `handleControllerMove`ï¼š
   - è®¡ç®—å°„çº¿ä¸æ»‘å—å¹³é¢äº¤ç‚¹
   - è½¬æ¢åˆ°å±€éƒ¨åæ ‡
   - é™åˆ¶åœ¨è½¨é“èŒƒå›´å†…
   - å›è°ƒ `onChange(value)`
4. ç”¨æˆ·æ¾å¼€æ‰³æœº â†’ `handleControllerRelease` â†’ `isDragging = false`

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡äº®ç‚¹

### 1. ç»Ÿä¸€è¾“å…¥æŠ½è±¡

**é—®é¢˜ï¼š** æ¡Œé¢å’Œ VR çš„è¾“å…¥æ–¹å¼å®Œå…¨ä¸åŒ
- æ¡Œé¢ï¼šé¼ æ ‡ã€é”®ç›˜
- VRï¼šåŒæ‰‹æŸ„ã€æŒ‰é’®ã€æ‘‡æ†

**è§£å†³æ–¹æ¡ˆï¼š** å®šä¹‰ç»Ÿä¸€çš„ `InputEvents` æ¥å£

```typescript
// ä¸šåŠ¡é€»è¾‘åªéœ€å…³å¿ƒè¯­ä¹‰åŒ–çš„äº‹ä»¶
const gameLogic = {
  handleSelectStart: (position, direction, hand) => { ... }
}

// æ¡Œé¢è¾“å…¥é€‚é…
onMouseDown â†’ onSelectStart(cursorPos, cursorDir, 'right')

// VR è¾“å…¥é€‚é…
controller.addEventListener('selectstart') â†’ onSelectStart(controllerPos, controllerDir, hand)
```

**ä¼˜åŠ¿ï¼š**
- ä¸šåŠ¡é€»è¾‘ä¸è¾“å…¥è®¾å¤‡è§£è€¦
- æ–°å¢è¾“å…¥æ–¹å¼ï¼ˆå¦‚æ‰‹åŠ¿è¯†åˆ«ï¼‰åªéœ€æ·»åŠ é€‚é…å™¨
- ä¾¿äºæµ‹è¯•å’Œè°ƒè¯•

### 2. VR Player Rig æ¨¡å¼

**é—®é¢˜ï¼š** VR ä¸­å¤´æ˜¾æ§åˆ¶ç›¸æœºï¼Œå¦‚ä½•å®ç°ç©å®¶ç§»åŠ¨ï¼Ÿ

**ä¼ ç»Ÿæ–¹æ¡ˆï¼š** ç›´æ¥ä¿®æ”¹ç›¸æœºä½ç½® â†’ **ç ´åå¤´æ˜¾è¿½è¸ª**

**æœ¬é¡¹ç›®æ–¹æ¡ˆï¼š** Player Rig å®¹å™¨
```typescript
VRPlayerRig (å¯ç§»åŠ¨)
    â””â”€â”€ Camera (å¤´æ˜¾æ§åˆ¶ï¼Œå±€éƒ¨åæ ‡)
```

**å·¥ä½œæµç¨‹ï¼š**
1. æ‘‡æ†è¾“å…¥ â†’ ç§»åŠ¨ `VRPlayerRig.position`
2. å¤´æ˜¾è¿½è¸ª â†’ è‡ªåŠ¨æ›´æ–° `Camera` åœ¨ rig å†…çš„å±€éƒ¨ä½ç½®
3. æœ€ç»ˆç›¸æœºä¸–ç•Œä½ç½® = rig ä½ç½® + å¤´æ˜¾åç§»

**ä¼˜åŠ¿ï¼š**
- ä¸å¹²æ‰°å¤´æ˜¾è¿½è¸ª
- æ”¯æŒä¼ é€ã€è·³è·ƒç­‰å¤æ‚ç§»åŠ¨
- æ§åˆ¶å™¨è·Ÿéšç©å®¶ç§»åŠ¨

### 3. æ§åˆ¶å™¨çˆ¶å¯¹è±¡åŠ¨æ€ç®¡ç†

**é—®é¢˜ï¼š** æ§åˆ¶å™¨åº”è¯¥è·Ÿéšç©å®¶ç§»åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// VR ä¼šè¯å¼€å§‹
moveControllersToParent(VRPlayerRig)

// VR ä¼šè¯ç»“æŸ
moveControllersToParent(scene)
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- ç©å®¶ç§»åŠ¨æ—¶ï¼Œæ§åˆ¶å™¨åº”è¯¥ä¿æŒç›¸å¯¹ä½ç½®
- æ¡Œé¢æ¨¡å¼ä¸‹æ§åˆ¶å™¨ä¸éœ€è¦è·Ÿéšç›¸æœº

### 4. ä¸‰å±‚è°ƒè¯•ç³»ç»Ÿ

| å·¥å…· | åœºæ™¯ | ç‰¹ç‚¹ |
|------|------|------|
| **VRDebugPanel** | VR/æ¡Œé¢ | 3D ç©ºé—´æ—¥å¿—ï¼Œæ‹¦æˆª console è¾“å‡º |
| **DebugGUI** | æ¡Œé¢ | ç²¾ç»†å‚æ•°è°ƒæ•´ï¼Œå¿«é€Ÿé¢„è®¾ |
| **VRDebugGUI** | VR | å®Œå…¨ 3D äº¤äº’ï¼Œæ§åˆ¶å™¨æ“ä½œ |

**è®¾è®¡åŸåˆ™ï¼š**
- VR ä¸­æ— æ³•ä½¿ç”¨ä¼ ç»Ÿ 2D GUI
- æ¡Œé¢è°ƒè¯•éœ€è¦ç²¾ç¡®æ•°å€¼è¾“å…¥
- ä¸¤ç§æ¨¡å¼å„è‡ªä¼˜åŒ–

### 5. ç®€å•ç‰©ç†ç³»ç»Ÿ

```typescript
// é‡åŠ›
verticalVelocity += gravity

// åº”ç”¨é€Ÿåº¦
target.position.y += verticalVelocity

// åœ°é¢ç¢°æ’
if (target.position.y < groundLevel) {
  target.position.y = groundLevel
  verticalVelocity = 0
}

// è·³è·ƒ
if (onGround) {
  verticalVelocity = jumpStrength
}
```

**ç‰¹ç‚¹ï¼š**
- ç®€å•é«˜æ•ˆ
- åŒæ—¶é€‚é…æ¡Œé¢å’Œ VR
- å¯æ‰©å±•ï¼ˆç¢°æ’æ£€æµ‹ã€å¡åº¦ç­‰ï¼‰

---

## ğŸš€ åº”ç”¨å¯åŠ¨æµç¨‹

```
1. main.ts
   â””â”€â”€ createApp(App).mount('#app')

2. App.vue
   â””â”€â”€ <ThreeScene />

3. ThreeScene.vue - onMounted
   â”œâ”€â”€ useThree() åˆå§‹åŒ–
   â”‚   â”œâ”€â”€ åˆ›å»º Scene, Camera, Renderer
   â”‚   â”œâ”€â”€ å¯ç”¨ WebXR
   â”‚   â”œâ”€â”€ åˆ›å»º VRPlayerRig
   â”‚   â”œâ”€â”€ è®¾ç½® OrbitControls
   â”‚   â””â”€â”€ ç›‘å¬ VR ä¼šè¯äº‹ä»¶
   â”‚
   â”œâ”€â”€ BasicScene åˆ›å»º
   â”‚   â”œâ”€â”€ åˆ›å»ºç«‹æ–¹ä½“ã€åœ°æ¿
   â”‚   â”œâ”€â”€ è®¾ç½®ç¯å…‰
   â”‚   â””â”€â”€ æ ‡è®°å¯äº¤äº’å¯¹è±¡
   â”‚
   â”œâ”€â”€ è°ƒè¯•å·¥å…·åˆå§‹åŒ–
   â”‚   â”œâ”€â”€ VRDebugPanel (æ—¥å¿—é¢æ¿)
   â”‚   â”œâ”€â”€ DebugGUI (æ¡Œé¢ GUI)
   â”‚   â””â”€â”€ VRDebugGUI (VR 3D GUI)
   â”‚
   â”œâ”€â”€ å®šä¹‰ gameLogic
   â”‚   â”œâ”€â”€ handleSelectStart
   â”‚   â”œâ”€â”€ handleGrabStart
   â”‚   â”œâ”€â”€ handleMove
   â”‚   â””â”€â”€ handleJump
   â”‚
   â”œâ”€â”€ useInputController
   â”‚   â”œâ”€â”€ ç›‘å¬é¼ æ ‡/é”®ç›˜äº‹ä»¶
   â”‚   â”œâ”€â”€ æ¡¥æ¥åˆ° gameLogic
   â”‚   â””â”€â”€ ç›‘å¬ VR ä¼šè¯åˆ‡æ¢
   â”‚
   â”œâ”€â”€ useVRControllers
   â”‚   â”œâ”€â”€ åˆ›å»ºå·¦å³æ‰‹æ§åˆ¶å™¨
   â”‚   â”œâ”€â”€ ç›‘å¬ select/squeeze äº‹ä»¶
   â”‚   â””â”€â”€ æ¡¥æ¥åˆ° gameLogic
   â”‚
   â””â”€â”€ animate() å¯åŠ¨æ¸²æŸ“å¾ªç¯
       â”œâ”€â”€ renderer.setAnimationLoop (VR å…¼å®¹)
       â”œâ”€â”€ åœºæ™¯æ›´æ–° (æ—‹è½¬ç«‹æ–¹ä½“)
       â”œâ”€â”€ ç‰©ç†æ¨¡æ‹Ÿ (é‡åŠ› + è·³è·ƒ)
       â”œâ”€â”€ æ¡Œé¢è¾“å…¥å¤„ç† (WASD, é¼ æ ‡)
       â”œâ”€â”€ VR è¾“å…¥å¤„ç† (æ‰‹æŸ„æŒ‰é’®, æ‘‡æ†)
       â””â”€â”€ VR GUI äº¤äº’ (æ‚¬åœ, æ‹–æ‹½)
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
VR3D/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                    # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ App.vue                    # æ ¹ç»„ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ ThreeScene.vue         # ä¸»åœºæ™¯ç»„ä»¶ï¼ˆæ ¸å¿ƒé€»è¾‘ç¼–æ’ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ composables/               # Vue Composablesï¼ˆå¯å¤ç”¨é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ useThree.ts            # Three.js åˆå§‹åŒ– + VR Rig
â”‚   â”‚   â”œâ”€â”€ useInputController.ts  # ç»Ÿä¸€è¾“å…¥æŠ½è±¡å±‚
â”‚   â”‚   â”œâ”€â”€ useVRControllers.ts    # VR æ‰‹æŸ„ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ useInteraction.ts      # (æœªä½¿ç”¨)
â”‚   â”‚   â””â”€â”€ VRInteraction.ts       # (æœªä½¿ç”¨)
â”‚   â”‚
â”‚   â”œâ”€â”€ scenes/
â”‚   â”‚   â””â”€â”€ BasicScene.ts          # åœºæ™¯å†…å®¹ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ utils/                     # å·¥å…·ç±»
â”‚       â”œâ”€â”€ VRDebugPanel.ts        # VR 3D æ—¥å¿—é¢æ¿
â”‚       â”œâ”€â”€ DebugGUI.ts            # æ¡Œé¢ 2D GUI (lil-gui)
â”‚       â”œâ”€â”€ VRDebugGUI.ts          # VR 3D äº¤äº’å¼ GUI
â”‚       â””â”€â”€ VRStats.ts             # æ€§èƒ½ç»Ÿè®¡
â”‚
â”œâ”€â”€ package.json                   # ä¾èµ–é…ç½®
â”œâ”€â”€ vite.config.ts                 # Vite é…ç½® (HTTPS for WebXR)
â””â”€â”€ tsconfig.json                  # TypeScript é…ç½®
```

---

## ğŸ› ï¸ æŠ€æœ¯è¦ç‚¹

### WebXR è¦æ±‚

**HTTPS å¿…é¡»ï¼š**
- WebXR API ä»…åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ (HTTPS) ä¸‹å¯ç”¨
- æœ¬åœ°å¼€å‘ä½¿ç”¨ `vite-plugin-mkcert` ç”Ÿæˆè¯ä¹¦

**å…¼å®¹æ€§ï¼š**
- Quest 2/3: âœ… åŸç”Ÿæ”¯æŒ
- PC VR (Steam VR): âœ… é€šè¿‡ WebXR API Layer
- ç§»åŠ¨ç«¯: âš ï¸ éƒ¨åˆ†æ”¯æŒï¼ˆéœ€æ£€æµ‹ï¼‰

### Three.js ç‰ˆæœ¬

- `three@0.181.0`
- ä½¿ç”¨ ES æ¨¡å—å¯¼å…¥ï¼š`three/examples/jsm/...`

### Vue 3 ç»„åˆå¼ API

- ä½¿ç”¨ `<script setup>` è¯­æ³•
- Composables æ¨¡å¼å®ç°é€»è¾‘å¤ç”¨
- Ref å“åº”å¼çŠ¶æ€ç®¡ç†

### TypeScript

- ä¸¥æ ¼ç±»å‹æ£€æŸ¥
- æ¥å£å®šä¹‰æ¸…æ™°
- æ›´å¥½çš„ IDE æ”¯æŒ

---

## ğŸ¯ æ‰©å±•æ–¹å‘

### 1. å¤šåœºæ™¯ç³»ç»Ÿ
```typescript
class SceneManager {
  private scenes: Map<string, Scene>
  switchScene(name: string) { ... }
}
```

### 2. ç½‘ç»œå¤šäºº
```typescript
// WebSocket åŒæ­¥ç©å®¶ä½ç½®
socket.on('player-move', (data) => {
  otherPlayers[data.id].position.set(...)
})
```

### 3. é«˜çº§ç‰©ç†
```typescript
// é›†æˆ Cannon.js / Ammo.js
const world = new CANNON.World()
world.gravity.set(0, -9.82, 0)
```

### 4. æ‰‹åŠ¿è¯†åˆ«
```typescript
// åŸºäºæ§åˆ¶å™¨è½¨è¿¹è¯†åˆ«æ‰‹åŠ¿
recognizeGesture(controllerPath) {
  if (isCircle(path)) return 'circle'
  if (isSwipe(path)) return 'swipe'
}
```

### 5. éŸ³æ•ˆç³»ç»Ÿ
```typescript
// Three.js Audio API
const listener = new AudioListener()
camera.add(listener)

const sound = new PositionalAudio(listener)
cube.add(sound)  // ç©ºé—´åŒ–éŸ³æ•ˆ
```

### 6. UI æ¡†æ¶åŒ–
```typescript
// å¯å¤ç”¨çš„ VR UI ç»„ä»¶åº“
class VRButton extends Component { ... }
class VRPanel extends Component { ... }
class VRKeyboard extends Component { ... }
```

---

## ğŸ“ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§ VR åº”ç”¨æ¨¡æ¿**ï¼Œå±•ç¤ºäº†å¦‚ä½•æ„å»ºè·¨å¹³å°çš„ 3D/VR åº”ç”¨ã€‚

**æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼š**
1. **è¾“å…¥æŠ½è±¡åŒ–** - ç»Ÿä¸€æ¡Œé¢å’Œ VR çš„äº¤äº’é€»è¾‘
2. **å®¹å™¨æ¨¡å¼** - VR Player Rig è§£å†³ç§»åŠ¨é—®é¢˜
3. **æ¨¡å—åŒ–** - Composables å®ç°é€»è¾‘å¤ç”¨
4. **è°ƒè¯•å‹å¥½** - ä¸‰å±‚è°ƒè¯•ç³»ç»Ÿè¦†ç›–æ‰€æœ‰åœºæ™¯

**é€‚ç”¨åœºæ™¯ï¼š**
- VR æ¸¸æˆåŸå‹
- VR åº”ç”¨å¼€å‘
- 3D å¯è§†åŒ–
- è™šæ‹Ÿå±•å…
- æ•™è‚²åŸ¹è®­

**å­¦ä¹ ä»·å€¼ï¼š**
- Three.js è¿›é˜¶ç”¨æ³•
- WebXR API å®è·µ
- Vue 3 ç»„åˆå¼ API
- è¾“å…¥ç³»ç»Ÿè®¾è®¡
- 3D UI æ„å»º

å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå¿«é€Ÿå¼€å‘å¤æ‚çš„ VR åº”ç”¨ï¼

